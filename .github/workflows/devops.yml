name: Tool-Man Demo

on:
  - push

jobs:

  devops:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Build the Docker image
      run: |
        git_ref_name=$(echo "${{ github.ref }}" | awk -F '/' '{print $NF}')
        docker build . --file Dockerfile --tag tool-man:demo-${git_ref_name}
        docker tag tool-man:demo-${git_ref_name} tool-man:demo
    - name: Deploy SIT ENV
      run: |
        echo 'This is a DEMO for deployment'
    - name: System Integration Testing
      run: |
        docker run -v $PWD/output:/workspace/output --rm tool-man:demo bash -c "robot -d output testcase"
    - name: Return Execution Results to Xray
      run: |
        cd $PWD/output
        curl -X POST -H "Content-Type: multipart/form-data" -u ${{ secrets.JIRA_USER }}:${{ secrets.JIRA_PASS }} -F "file=@output.xml" "${{ secrets.JIRA_URL }}/rest/raven/1.0/import/execution/robot?projectKey=${{ secrets.JIRA_PROJECT }}&testPlanKey=${{ secrets.JIRA_TESTPLAN }}"
    - name: Return Info to Jira Issue
      run: |
        JIRA_KEY=$(git log -n 1 | tail -1 | awk '{print $1}')
        curl -X POST -H "Content-Type: application/json" -H "Accept: application/json"  -u ${{ secrets.JIRA_USER }}:${{ secrets.JIRA_PASS }} "${{ secrets.JIRA_URL }}/rest/api/2/issue/$JIRA_KEY/comment" -d "{
          \"body\": \"CI Job [$GITHUB_WORKFLOW # $GITHUB_RUN_NUMBER|$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID] Complete.\"
        }"
